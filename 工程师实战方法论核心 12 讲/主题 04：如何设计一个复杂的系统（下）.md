## 主题 04：如何设计一个复杂的系统（下）

### 1. 引言

设计复杂系统的能力是高阶工程师的必备能力，设计出完备、健壮、优雅、前瞻的系统是工程师的不懈追求。在上一篇文章中，笔者介绍了设计一个复杂系统的第一步：深入理解业务。本文作为**《如何设计一个复杂的系统》**主题的延续，将从技术的角度出发带领读者掌握系统设计的思考框架和方法论（通俗地说，就是系统设计的套路）。

### 2. 系统设计简述

回顾自己在过往职业生涯所经历的项目，在做系统设计的时候都会按照一个套路去做，这个套路就是：

> 系统设计的目的 -> 系统设计的目标 -> 围绕目标的核心设计 -> 围绕核心设计形成设计原则 -> 各子系统/模块的详细设计

**系统设计的目的**

首先要明确做这个系统设计的目的是什么？部分工程师在做系统设计的时候，拿到需求就迫不及待地展开设计了，甚至无暇顾及为什么要做一个新系统的设计，或者为什么要做一个系统的重构/演进设计。如果系统设计的目的都没有搞清楚，在系统设计时很容易出现偏差。

**系统设计的目标**

在明确了系统设计的目的之后，接下来需要整理出系统设计的目标，简而言之，就是把系统设计目的相关的描述，转换为可衡量的目标的描述。之所以要形成可衡量的目标，主要目的有二：

- 后续系统设计围绕目标来进行，避免偏题；
- 清晰、可衡量的系统建设的目标有助于评估系统的建设效果和进度。

**围绕目标的核心设计**

明确了设计目的和目标，接下来便是通过设计去实现上面的目标。这是系统设计中最为重要的环节，这个环节需要通盘考虑、权衡取舍，要求工程师具备良好的技术深度、技术视野，同时充分理解业务。在核心设计这个阶段，通常会提取出一些新的衡量系统设计的目标，应将其增加到系统设计中，确保最后的实现与设计目标之间的偏差是可视的。

**围绕核心设计形成设计原则**

完成系统核心设计之后，进一步基于核心设计提炼出系列设计原则，从而确保在子系统/模块的详细设计中有可遵循的统一原则（一个复杂的系统通常由多名工程师协同开发，必须有统一的设计原则加以规范，而不能各自为政、百花齐放），并在详细设计中体现出来，从而保障整个大的系统设计的一致性。

**各子系统/模块的详细设计**

基于前面的铺垫，对于大多数工程师而言，完成子系统/模块的详细设计应该不会太困难，毕竟，在一名工程师的职业生涯中，大多数时间都在从事子系统/模块的设计和开发。

### 3. 系统设计详解

在上一节中，笔者概略性地介绍了系统设计的方法，将系统设计切分为五个步骤：

1. 明确系统设计的目的；
2. 规划系统设计的目标；
3. 围绕目标展开核心设计；
4. 基于核心设计制定设计原则；
5. 各子系统/模块的详细设计。

本节将围绕这五个步骤进行详细阐述。

#### **3.1 系统设计的目的**

作为系统设计的第一步，其重要性无需赘言。系统设计通常有两种情形：

1. 建设一套新系统；
2. 对原有系统进行比较大的改造升级。

两种情形虽有所差异，但动静都不小，而这么大的动作背后一定有合理的目的支撑。结合**《如何设计一个复杂的系统（上）》**一文中的介绍，系统的设计的目的应忠实于两个基本原则：

- 第一、支撑业务当下的需求；
- 第二、支撑业务未来的发展。

具体而言，系统建设的目的不应脱离这个范围：应对业务层面临的挑战，解决系统层面临的问题。在实践中，很多时候工程师容易**在出发点跌倒**——纯粹出于个人诉求（技术情怀、ZB 等）发起大动作的系统重构，往往烂尾，甚至导致严重后果。

系统设计与业务通常是强相关的，在大多数场景中，业务都扮演着系统设计驱动的角色。作为负责系统设计的工程师，首先必须充分理解业务并做好需求转换，再分析是否需要建设新系统或重构升级现有系统。总的来说，在做系统设计前，须明确系统建设的目的，确保系统建设有价值、有意义，同时确保整个系统设计是能让目的达成的。

**举例说明**

> 以支付宝为例，虽然支付宝诞生于 2004 年，但是，直到 2016 年才开始建设支付宝会员体系。假设时间回到 2016 年，公司决策层提出打造支付宝会员体系，在此，简单分析一下系统设计的目的：
>
> 1. 业务简述：以积分和权益为基础，打造支付宝会员体系；通过会员体系，提高用户的忠诚度、活跃度，促进公司收益增长。
> 2. 设计目的：现有系统无法满足业务诉求，因此，需要建设一个新的系统来落地支付宝会员体系，并支撑会员体系当前的需求和未来的发展。

#### **3.2 系统设计的目标**

在明确了系统设计的目的之后，接下来需要整理出系统设计的目标，简而言之，就是把系统设计目的相关的描述，转换为可衡量的目标的描述。之所以要形成可衡量的目标，主要目的有二：

1. 后续系统设计围绕目标来进行，避免偏题；
2. 清晰、可衡量的系统建设的目标有助于评估系统的建设效果和进度。

**目标须清晰可衡量**

系统设计的目标，某种意义上可以理解为系统设计要解决的系列问题，目标必须清晰、可衡量。比如：

1. 支持 2W QPS 的访问量；
2. 支持“千人千面”；
3. 支持多渠道接入；
4. 支持接口级监控；
5. 支持业务数据报表生成。

**目标须详略得当**

此外，需要注意，系统设计的目标不能过于抽象也不宜过于具体。如下图所示，如果目标设置为提升用户体验或者提升性能，就太抽象了；如果设置为弱网条件下减少网络耗时，又过于具体。事实上，从系统总体设计的层面，目标制定为页面秒开（页面打开耗时不超过 1 秒）就可以了。

![在这里插入图片描述](https://images.gitbook.cn/2045b9f0-61ca-11ea-be13-9d4b32a4c9f6)

#### **3.3 围绕目标的核心设计**

在制定好系统设计的目标之后，接下来便是最重要的环节——设计可实现上面目标的整体方案。对于复杂的系统，工程师应基于系统设计的目标，从系统层面考量这些目标背后存在的核心问题。只有理清了面临哪些核心问题，才能更加高效地进行系统设计来解决这些问题。需要注意的是，**复杂系统的核心设计，切忌陷入子系统和模块细节**，这是下一个阶段要做的事情。

**达成目标的核心问题：**

> A problem well-defined is a problem half solved. (John Dewey)

多年以来，在笔者参与过评审的众多设计方案中，也遇到过一些非常糟糕的设计，它们大多不清楚自己到底要解决什么问题，总是觉得这个问题我要解决，那个问题我也要解决，甚至不是问题的问题我也要解决。然后设计出了一个能解决所有“问题”的方案。但是，实际情况是有些问题根本不是问题，有些问题确实是问题但却不是核心问题，有些问题是核心问题，但却不是当下最核心的问题。

在此，以支付宝会员系统为例，先简单介绍一下：会员通过支付宝消费、做任务、签到等途径可以获得积分奖励；积分又可以用来兑换权益；权益分为实物权益（如电动牙刷、扫地机器人）和虚拟权益（如优酷 30 天会员，10 元购物红包）；权益来源有两种，即支付宝出钱采购和合作商赞助（如优酷权益）。对于这样一个系统，欲达成目标，要解决的核心问题有：

1. 如何支撑每秒高达 50 W 笔积分的发放？这个问题来源于“双十一”等大促场景，大量用户集中使用支付宝交易，而通过支付宝交易需奖励积分。
2. 如何保障权益兑换过程的一致性？权益兑换涉及积分扣减和权益发放、领取，其中积分扣减在会员侧进行，权益兑换和领取经会员侧中转最终在合作商侧进行。
3. 如何保证会员首页加载时间不超过 0.5S？会员首页涉及等级/积分查询、特权列表查询、活动查询、权益列表查询、库存查询等，其中权益库存还需查询赞助商。
4. 其它问题略。

**解决核心问题的设计**

在明确了达成目标所面临的核心问题后，就进入到解决核心问题的设计环节了。估计很多读者会跳过上面的内容，直接奔向这个环节，这是典型的工程师思维——只关心怎么解决问题。这并不是一个好的习惯，在此，笔者强烈建议做系统设计的工程师，不要着急，一步一步来。

接续支付宝会员系统的例子，来讲解“解决核心问题的设计”。在此，仅就如何支撑每秒高达 50 W 笔积分的发放这一核心问题展开，抽丝剥茧：

1. 会员积分发放流量最大的场景是“双十一”等大促，大量用户集中使用支付宝付款。
2. 交易支付与积分发放是两个链路，之间宜采用**消息队列中间件**来沟通，交易完成则发送消息给会员系统，通知奖励积分。
3. 积分发放消息是堆积还是即时消费？由于流量过于巨大（50W/S），即时消费消息并发放积分成本过高，那堆积可行吗？积分发放消息量在十亿级，况且交易链路还涉及其它消息，消息中间件可能被压垮。
4. 既然积分发放消息不能大量堆积，也不能即时消费，那就必须采用其它方式持久化，下一步就是持久化方式选型。
5. 最常用的持久化方式就是数据库，哪种数据库合适呢？进一步分析场景。
6. 积分发放消息经过转换持久化到数据库之后，最终还是要捞出来作为发放积分的依据的，怎么才能高效地写入和捞取数据呢？一般的数据库显然不支持，有一种数据库支持——HBase，关于 HBase，感兴趣的读者可自行查询资料。

经过上面层层分析，基本上明确了解决思路：

> 积分发放消息 -> 持久化入 Hbase -> 分布式任务从 HBase 捞取数据 -> 发放积分，据此，从系统总体设计层面整理出如下子框架图：

![在这里插入图片描述](https://images.gitbook.cn/c67a4530-61dd-11ea-baf8-f1bca404e984)

#### **3.4 围绕核心设计形成的设计原则**

一个复杂的系统通常由多名工程师协同开发，必须有统一的设计原则加以规范，而不能各自为政、百花齐放。因此，在完成系统核心设计之后，需进一步基于核心设计提炼出系列设计原则，确保在子系统/模块的详细设计中有可遵循的统一原则。这些设计原则应在详细设计中体现出来，从而保障整个大的系统设计的一致性。在此，笔者仅就两个方面列举几条设计原则。

**协同层面**

为了提高协同开发效率，各个子系统/模块设计者应按照统一的模版编写详细设计文档，模版非常灵活，但通常需要包括术语介绍、模型、框架图、接口描述等，其中接口描述需详细说明入参、出参、错误码。

**工程层面**

不同公司，不同部门，甚至不同团队在工程层面都有自己的风格，从工程层面制定设计原则十分必要。在此列举几条原则供读者参考：

- 原则 1：数据库一律采用 OceanBase，原则上不得再使用 Oracle Database（阿里内部一直在推行“去 O 计划”）。
- 原则 2：从外部接入的基础能力一律放在 Common 层 service 目录下，避免多个子系统接入同一外部能力时引起混乱。
- 原则 3：系统对外异常统一采用 XxxCommonException，错误码统一采用 XxxErrorCodeEnum 中定义的错误码，不得随意增加。
- 原则 4：略。系统设计工程师应从全局出发，结合具体情况制定原则。

#### **3.5 各子系统/模块的详细设计**

基于前面的铺垫，就到了系统设计的最后一个环节，对于大多数工程师而言，这个环节应该是最为熟悉的，毕竟在一名工程师的职业生涯中，大多数时间都在从事子系统/模块的设计和开发。

一个复杂的系统通常需要拆解为多个子系统/模块，与系统核心设计不同，子系统/模块的设计是一种详细设计，需要从细节层面考量问题，所做的设计用于直接指导开发。同时，需要特别注意：子系统/模块本质上也是一个系统，并且子系统/模块之间通常相互依赖，因此详细设计并不简单。下面将结合案例讲解详细设计的方法。

**第一步：绘制子系统设计图**

首先明确三个问题：子系统/模块需要对外输出哪些能力？对其它子系统有何依赖？需要建设哪些辅助能力？问题明确后，可通过绘图理清整个子系统/模块的框架。以常见于电商 APP 的组合任务活动为例，整体框架图如下所示（其中基础能力即该子系统对其它子系统的依赖）：

![在这里插入图片描述](https://images.gitbook.cn/917cd7e0-61be-11ea-8032-6b1a3b46917c)

**第二步：设计模型和接口**

关于模型和接口的设计，在主题《如何设计模型》和《如何设计一个好的 API》中已经有详细的解读，这里不再赘述。接续上面的例子，给出一个接口设计的效果示意图：

![在这里插入图片描述](https://images.gitbook.cn/d0cb7cf0-61d0-11ea-8fc3-cbeb82bc1da0)

**第三步：流程图/时序图**

利用好流程图/时序图，可以详细、直观地梳理接口的内部逻辑，同时有助于全面分析，避免遗漏分支或业务场景。

### 4. 总结

设计一个复杂的系统并非易事，设计能力的培养亦非一朝一夕可成。回顾过往，笔者在系统设计的过程中也曾犯过不少的错误，其中不乏惨痛教训，正是在经历一系列错误所导致的苦果后，才逐渐明白系统设计需注意的问题，并形成了一套自己的方法论（套路）。

本文是《如何设计一个复杂的系统》主题的下篇，建议读者通读这个主题的两篇文章，定会有所收获。最后，总结一下做好系统设计需要具备的能力：

- 深度理解业务，了解其当下的痛点和未来的发展方向；
- 技术抽象能力，能够将业务快速映射到技术；
- 知识储备，能够全面地考虑问题，洞悉关键节点；
- 技术功底，技术视野，能够做好技术选型。

**致谢：感谢毕弦对本文的贡献。**