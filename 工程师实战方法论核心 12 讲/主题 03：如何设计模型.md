# 主题 03：如何设计模型

### 1. 引言

模型是一种将事物形象化的有效手段，利用模型可将现实世界中的事物及事物之间的关系准确地表达出来。模型设计本质上就是系统地实施抽象的过程。

很多时候，工程师面对的需求都是以具象的现实世界事物概念来描述的，遵循的是人类世界的语境。为了将需求落地，工程师需要开展一系列的工作，其中，模型设计尤为重要，可划分为以下几个步骤：

- 第一步：需求调研，确定用户需要哪些信息，建立哪些应用，常用的操作及对象有哪些，产出业务概念和业务事件。
- 第二步：概念分析，需求调研所得到数据的高层描述抽象，产出业务 ERD（Entity Relationship Diagram）、业务 DFD（Data Flow Diagram）。
- 第三步：逻辑设计，对概念数据模型建议的分解和细化，根据业务规则确定的关于业务对象、业务对象的数据项及对象之间关系的基本蓝图。
- 第四步：物理设计，对已经确定的逻辑结构选择适当的物理结构，包括存储结构等最终实现。

从上述步骤可以看出，整个模型设计的过程是一个从整体到局部、从高层模型设计到细节逐步细化的过程。在实践中，模型设计过程可以分为：概念分析、逻辑设计、物理设计三个阶段。每个阶段的输出都是下一阶段的输入，每个阶段完成后，都要进行阶段性评审。并根据评审结果修改输出，若修改范围涉及上一阶段输出，就应该返回修改上层输出，保证上下层设计的一致性。这就是一个自上而下设计、自下而上验证并且不断迭代完善的过程。同时，在每个阶段内部，同样遵从上面的原则与方法。

### 2. 预备知识

#### **2.1 概念 & 术语**

在正式介绍模型设计方法之前，首先介绍一下模型设计所涉及的基本概念和术语，如下所示。

**1. 数据模型**

数据模型是对现实世界中事物之间的数据特征的抽象。数据模型中描述的内容包括三部分：数据结构、数据操作、数据约束。

- 数据结构：数据结构主要描述数据的类型、内容、性质以及数据间的联系等。数据结构是数据模型的基础，数据操作和约束都建立在数据结构之上。不同的数据结构具有不同的操作和约束。
- 数据操作：数据操作主要描述在对应的数据结构上的操作类型和操作方式。
- 数据约束：数据约束主要描述**数据结构内**的制约和依存关系，以及数据动态变化的规则。数据约束用以保证数据的正确、有效和相容。

**2. 概念数据模型**

概念模型是最终用户对数据存储的看法，反映了最终用户综合性的信息需求，它以数据类的方式描述企业级的数据需求，数据类代表了在业务环境中自然聚集形成的几个主要类别数据，概念模型的内容包括重要的实体及实体之间的关系，概念数据模型的目标是统一业务概念。

**3. 逻辑数据模型**

逻辑模型反应的是系统分析设计人员对数据存储的观点，是对概念数据模型的分解和细化。逻辑模型是根据业务规则确定的关于业务对象、业务对象的数据项及对象之间关系的基本蓝图。逻辑模型的内容包括所有的实体和关系，确定每个实体的属性，定义每个实体的主键，指定实体的外键，需要进行范式化处理。

**4. 物理数据模型**

物理模型是在逻辑模型的基础上，考虑各种具体的技术实现因素，进行数据库体系结构设计，真正实现数据在数据库中的存放，物理模型的内容包括确定所有的表和列，定义外键用于确定表之间的关系等内容。

#### **2.2 模型推导前的准备**

借鉴行业成功经验整理出来的信息是模型设计的关键输入，也是衡量模型设计质量的标准。好的模型设计的首要因素是对业务的理解，包括对现有业务运营模式的理解以及业务发展趋势的分析，而不是模型设计的方法和技巧（技术只是一种实现手段）。与模型设计相关的需求搜集与分析主要包括以下方面：

1. 模型设计的目标以及覆盖业务范围的定义，以确定模型设计需要包含哪些信息和数据；
2. 模型设计进度的要求，以确定资源投入；
3. 搜集整理业务概念、术语、信息及数据的处理规则；
4. 分析影响业务运营成功的关键因素，也就是核心的运营理念，以及支撑这些因素所需要的数据；
5. 性能相关的信息，如业务的规模、吞吐量、响应时间等要求，以确定性能设计方面需要考虑的问题及解决方案（物理设计阶段考虑）；
6. 对应用系统期望的有效运行期限，以及在有效期内业务变化的可能性分析，这些信息会影响期望模型支持哪些层次上的变化；
7. 对已有应用系统的模型的分析，也是新的模型设计的重要信息来源。

### 3. 概念模型分析

概念模型是从业务的视角对业务运营过程中涉及的信息进行结构化描述，是高层次的粗粒度模型，是对现实世界问题的 IT 表达；它是不包含设计实现细节的设计模型，通过对关键的实体、关系、规则的描述定义关键业务概念，确定业务概念的关键属性及其值域；某种意义上，概念模型是一种分析模型。

- 输入：需求文档、现有系统分析，业务目标、范围和定位。
- 输出：概念 ERD、概念 DFD、概念阶段事件列表、业务功能与角色的对应关系。

#### **3.1 分析步骤**

1. 划分业务活动范围；
2. 寻找业务活动范围中的业务实体并描述定义；
3. 分析并描述业务实体之间的关系，包括：从属关系分析、业务处理活动分析、管理活动分析；
4. 分析并描述业务实体关键属性；
5. 分析属性所对应的业务值域。

**注意事项**

1. 只分析业务人员角度可见的 ER 关系；
2. 避免以系统中如何设计的视角分析 ER；
3. 实体可以增加核心属性；
4. 概念模型分析需达到的程度：所有的需求 ERD 都体现了，才算到位。

#### **3.2 概念分析实践**

**1. 获取业务概念**

- 框定业务范围

业务范围即业务领域，是我们要研究的跟某个核心事务相关的具体业务集合，如果有业务文档，我们可以从业务文档中整理出业务实体和业务事件，同时应注意借鉴行业成功经验。

- 关键业务概念

在确定业务范围之后，应在其中提取关键业务概念。这些业务概念可进一步转化为关键业务实体，形成实体定义。举个例子：用户从平台商家处购买商品。其中名词“用户”、“商家”、“商品”为业务活动的参与者（承载者），可以形成实体。

**2. 获取业务活动**

列出业务层面的事件列表，将业务处理活动逐层的进行分解，一个业务领域为了实现一个目标，需要有多个业务活动进行支撑，而每个业务活动又需要多个子活动进行支撑。自上而下是活动的分解过程，业务活动的分析可以是一步到位的，也可以是逐步完善的。

接续上面的例子（用户从平台商家处购买商品），业务层面涉及的事件有：“购买”、“退款”、“退货退款”、“商家发货”、“买家收货”等，这些事件都是业务相关的事件（活动），正是这些活动将业务承载者（买家和商家）联系起来。

**3. 模型推导**

根据实体之间的从属关系画出静态关系，将每个活动展开画出 ERD。业务活动通常是分层的，所以对应的这些活动的 ER 展开也是分层的。推导的过程中每个实体都有来源，要么通过从属关系分析出来，要么通过业务活动菱形展开推导出来，而不应该凭空出现。ER 推导是一个多次反复迭代的过程，如下租房业务分析片段：

![在这里插入图片描述](https://images.gitbook.cn/1d985860-57b2-11ea-86c2-b7415b9b2ae3)

在活动推导过程中，核心实体的核心属性会最早分析出来，并且有可能会在分析的过程中分离成一个单独的实体。在活动的推导后期，给实体补充上业务关键属性、以及属性的值域。

### 4. 逻辑模型设计

逻辑模型设计是在概念模型设计的基础上扩展和细化形成的解决方案视角的模型。逻辑模型重在设计，而概念模型重在分析。

逻辑阶段设计的目标是设计支持现实世界概念模型的逻辑模式和子模式，并将概念模型转换为存储所支持的数据模型。在该过程中需要对概念分析阶段所涉及的业务进行逐步细化，以达到能在系统中实现的程度。为此，需要从业务功能中抽象出处理功能，并且对实体和处理进行归纳抽象，并且在分析数据流程时，要表达出具体数据的流向。

逻辑模型是在概念模型的基础上，加入设计的因素，对模型元素进行细化和扩充，并逐步应用规范化的策略对数据规范化，消除冗余数据，形成理想结构的详细模型。逻辑模型是从解决方案的角度对数据的结构化描述；逻辑模型仍然是**技术中立**的模型，用于指导系统建设的模型设计。需要注意的是，逻辑模型并不是系统的数据结构，系统建设时，仍然需要在逻辑模型的指导下做进一步的设计，并进行物理模型设计，形成最终的系统数据结构。

- 输入：概念阶段的输出物；需求类文档。
- 输出：逻辑阶段 ERD、逻辑阶段 DFD、概念阶段与逻辑阶段实体对应关系、概念阶段与逻辑阶段功能（活动）对应关系、业务场景验证文档、功能列表。

#### **4.1 设计步骤**

1. 在概念分析的基础上划定系统边界；
2. 去除仅仅代表业务概念，而不需要应用系统实现的实体和处理；
3. 将模型转化为关系模式；
4. 将模型中相近的实体和处理进行归纳化抽象，消除冗余；
5. 引入设计层面所需要的实体和处理，并逐层细化；
6. 设计实体类的属性，设计相关的值域，确定实体类的候选标识并进一步确定主标识，建立与属性相关的业务规则；
7. 定义逻辑实体和处理。

**注意事项**

1. 逻辑模型仍然是一个技术中立的模型，逻辑模型的设计不要过多地考虑性能方面的问题，也不要考虑数据如何分布、存储；
2. 最终设计出全属性模型；
3. 通过和 DFD 进行交叉校验找问题。

#### **4.2 逻辑设计实践**

**1. ER 从属关系转换**

将 ERD 转换为关系模型实际上就是要将实体、实体的属性和实体之间的联系转化为关系模式，这种转换一般遵循如下原则：概念层面的实体转化成逻辑实体的过程中，需根据实体类、关联关系存在的相似性，进行适当层次的抽象，形成更为通用的概念；概念层面的实体属性可直接带到逻辑实体中，并补充类型和长度等描述。

**2. 归纳与细化**

- 对于实体进行完善、细化和抽象。
- 将模型中相近的实体进行归纳抽象，消除冗余，从信息实体中提取出数据实体；抽象是一个由多到少的过程，目的是要达到模型与业务的无关性，实现数据模型的稳定持续发展。
- 抽象过程中属性和值域需做相应整合。
- 引入设计层面所需要的实体，然后对系统开展的活动进一步细化，使得处理功能越来越逼近于函数的实现形式；细化是一个由少到多的过程，细化的目标是完善实体和功能。
- 细化过程中需补充完整属性和值域。

**3. 属性与值域**

- 添加全属性、数据类型
- 值域转换

**4. 业务活动向系统功能的转化**

事件的抽象、合并与细化，对粗粒的平台服务进行细化（可以直接细化到单个实体的 CRUD），然后对多个业务场景对应的相似平台服务进行合并。以存款、取款、转账为例，用户业务场景有：存款、取款、转账；需要平台提供的服务有：存款和取款。

![在这里插入图片描述](https://images.gitbook.cn/f6d76720-57cf-11ea-8855-bf9ec219a956)

其中，平台服务可以进行细粒度分解，存款服务可分解为：创建账户、存入金额、查询账户；取款服务可分解为：查询账户、支出金额，分解后平台服务如下：

![在这里插入图片描述](https://images.gitbook.cn/002e9b90-57d0-11ea-b489-430c8367f421)

存款服务与取款服务又存在相同的“查询账户”操作，对相同服务进行合并操作，如下：

![在这里插入图片描述](https://images.gitbook.cn/3fff2000-57d0-11ea-a826-b3f98a7bb4e3)

### 5. 物理模型设计

物理模型是在逻辑模型设计的基础上，结合具体使用的数据库管理系统，加入对系统实现的考虑，包括系统的可实现性、系统的性能等。从实现的角度，在逻辑模型的基础上做必要的反向规范化的设计、模型物理结构的设计，加入程序控制和动作控制。

物理模型设计的目标是根据 DBMS（Database Management System）特点和处理的需要，进行物理存储等安排；根据系统和用户数量对逻辑设计中模型的功能与实体进一步细化，使功能/数据能在具体的系统中实现，需要考虑效率、接口等问题。在该阶段还需做一些数据结构的冗余设计以提高数据访问的性能，包括增加冗余字段、增加派生字段、增加冗余表、对表结构重组、数据分割（水平分割、垂直分割），优化设计索引、调整数据库对象存储参数、设计视图等。在做数据结构冗余设计的时候，要同时考虑数据完整性的保证机制。

- 输入：逻辑阶段的输出物；需求类文档。
- 输出：物理阶段 ERD、物理阶段 DFD、物理阶段与逻辑阶段实体对应关系、物理阶段与逻辑阶段功能对应关系、功能列表。

#### **5.1 设计步骤**

1. 设计 UI/系统接口；
2. 考虑性能，进行反规范化设计；
3. 设计数据存储(内存/文件/DB)；
4. 设计索引、视图、分区、存储参数等性能参数；
5. 引入具体实现层面所需要的实体和处理，并细化；
6. 设计程序异常处理及系统管理；
7. 设计其他技术实现细节。

#### **5.2 物理设计实践**

**1. 逻辑模型转换为物理模型**

- 转换到数据库：逻辑实体转换为数据库的物理表，关系转换为表间的外键约束，数据类型转换为具体 DBMS 的数据类型，逻辑值域转换为物理模型的值域。
- 转换到其它结构：内存数据库、内存、文件等。

**2. 性能设计**

- 数据量：初始数据量有多少，每天或者每月的数据增量是多少？每天或者每月每个功能的数据增量是多少？
- 响应时间：关键业务的响应时间是多少？
- 并发：高并发的业务（功能）是哪些？多少的并发量？
- 热点（数据的存取频度）：最多的数据读写发生在哪些表上？

**3. 稳定性设计**

逐层分析业务链路中各个环节存在的风险点；评估风险点一旦发生所造成的影响；对于那些高危风险点（风险发生造成的影响难以接受），制定相应的应对预案。

### 6. 模型验证

在模型分析设计阶段，都需要对模型设计的结果进行阶段性验证，以及时发现模型设计中的问题，从而对及时更正模型。

#### **6.1 验证什么？**

模型验证主要的验证点：模型是否完整地支撑业务、是否支撑上一层的推导、设计是否合理、本层设计是否和上层有冲突、设计是否和业务有冲突。在进行模型验证时，需要考虑以下几个方面（以第一条和第二条为主）：

- 验证模型的完整性，模型是否覆盖需要的数据，是否能够满足业务需求，支持关键的业务运营模式和理念。
- 验证模型的可行性，模型是否简洁易懂，使业务人员能够准确把握和理解模型，基于模型的应用系统是否能够实现和实施。
- 验证模型的可复用性，模型的设计是否具有良好的通用性，能够被多个应用系统复用。模型的设计不能针对特定的应用系统组织和设计，否则很难具有良好的通用性。
- 验证模型的稳定性和灵活性，稳定性和灵活性是验证模型适应业务变化的能力。面对业务变化，模型不需要改变就能够适应业务需求，是模型稳定性的表现；当业务变化对模型产生冲击，通过对模型进行适当的扩展，而不影响已有的结构来适应业务需求，是模型灵活性的表现。

#### **6.2 验证手段**

**1. 业务场景验证**

首先描述业务场景，即先拿出某个业务场景，获取参与者、流程、输入输出等相关信息，然后针对该业务场景的实现，一个步骤一个步骤地指出每个步骤分别是谁操作、读取什么输入、怎么加工、处理的规则是怎样的以及处理结果保存到什么地方。

如果流程串不起来，或者该输入的数据找不到，或者输出数据没有地方保存，这些都是明显的错误，出现其中之一即为不通过。

**2. CRUD 验证**

CRUD 分别代表对数据的创建、读取、编辑更新和删除。CRUD 验证的做法是：将业务事件（活动、功能）和实体（属性、值域）分别放置到一个矩阵的行和列上，这样，每个业务事件就和每个实体都有一个交叉的格子，在每个格子里写上代表的业务事件对此实体操作的字母，如 C（创建）R（读取）等，就构成了一个 CRUD 矩阵。

在我们研究的业务领域中，每一实体（属性）必被且仅被某一个业务事件创建；每一实体（属性）必被某一业务事件读取；每个实体可被一个或多个业务事件更新，每个实体通常只能被一个业务事件删除。

**3. ER 和 DFD 的互相验证**

对于一个活动，可以分别使用 ER 和 DFD 的形式描述：DFD 描述活动本身的过程；ER 可以描述活动的过程，同时也能描述活动最后产生的结果、实体之间的静态关系。那么，用 ER 和 DFD 分别描述的某个活动，就其描述的过程和结果来说应该是一样的。如果 ER 和 DFD 对于活动的表达不一致，那么说明二者的推导过程中至少有一个是错误或者不合适的。

### 7. 总结

模型设计是一个从整体到局部、从具体到抽象，自上而下设计、自下而上验证并不断迭代完善的过程。模型设计是软件系统设计中极为关键的环节，因此，掌握模型设计方法论尤为必要。本文中，笔者根据自身多年的研发实践将模型设计过程划分为：概念分析、逻辑设计、物理设计三个阶段，并针对每个阶段进行了详细的论述。

需要特别说明的是，好的模型设计的首要因素是对业务的理解，包括对现有业务运营模式的理解以及业务发展趋势的分析，而不是模型设计的方法和技巧，鉴于此，在开始模型设计之前，应充分借鉴业领域的成功经验。