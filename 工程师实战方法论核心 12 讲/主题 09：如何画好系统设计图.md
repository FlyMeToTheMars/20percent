## 主题 09：如何画好系统设计图

### 1. 引言

系统架构图是为了具象地呈现软件系统的整体轮廓、各个组件之间的相互关系和约束边界，以及物理部署和演进方向的整体视图。软件架构图是一种非常好的表达方式，一图胜千言，在项目评审、内部交流、方案归档以及晋升答辩中，好的系统架构图大有裨益。

系统架构图虽好，但也不可滥用。在互联网领域，对于一个较为复杂的软件系统，由于业务迭代频繁，通过创建和维护系统设计图来提供准确且有价值的内容并非易事。很多时候，工程师容易陷入误区：为系统中具有高波动性的部分创建详细的设计图，进而增加维护成本，甚至演变成一种负担。此外，大多数利益相关者（如产品、运维、测试）通常只对反映系统模块和边界的高级架构图感兴趣，而对详细的系统设计图并不感兴趣。鉴于以上因素，绘制系统架构图应充分考虑场景和受众。

### 2. 传统的“4+1”画图法

1995年，Philippe Kruchten 在 *IEEE Software* 上发表了题为 *The 4+1 View Model of Architecture* 的论文，引起了业界的极大关注，并最终被 RUP 采纳。根据“4+1”视图，系统架构图可以分为场景视图、逻辑视图、物理视图、处理流程视图和开发视图，如下图所示：

![在这里插入图片描述](https://images.gitbook.cn/51a7ca30-65dd-11ea-a068-fd4424b8f753)

- **场景视图**，用于描述系统的参与者与功能用例之间的关系，反映系统的最终需求和交互设计，通常由用例图组成。
- **逻辑视图**，用于描述系统软件功能拆解后的组件关系、组件约束和边界，反映系统整体组成与系统如何构建的过程，通常由 UML 的组件图和类图来表示。
- **物理视图**，用于描述系统软件到物理硬件的映射关系，反映出系统的组件是如何部署到一组可计算的机器节点上，用于指导软件系统的部署实施过程。
- **处理流程视图**，用于描述系统软件组件之间的通信时序，数据的输入输出，反映系统的功能流程与数据流程，通常由时序图和流程图表示。
- **开发视图**，用于描述系统的模块划分和组成，以及细化到内部包的组成设计，反映系统开发实施过程。

### 3. “C4 模型”画图法

传统的“4+1”软件系统架构图分类很细致，但是，互联网领域应用系统迭代频繁，有些产品甚至刚上线便被永久下线，为每一个应用系统绘制并维护五种不同的视图缺乏实践意义，更是一种负担。鉴于此，Simon Brown 于 2017 年提出了一种更简洁的系统架构图绘制方法，即 “C4 模型” 画图法，C4 代表上下文（Context）、容器（Container）、组件（Component）和代码（Code）——一系列分层的图表，可以用这些图来描述不同缩放级别的软件架构，每种图表都适用于不同的受众。

C4 模型使用容器（应用程序、数据存储、微服务等）、组件和代码来描述一个软件系统的静态结构，下文将详细介绍。

#### **3.1 Context**

系统上下文图，它显示了正在构建的软件系统，以及系统与用户及其它软件系统之间的关系。这个图的受众可以是开发团队的内部人员、外部非技术或技术人员。以下是一个互联网银行系统的系统上下文图示例：

![在这里插入图片描述](https://images.gitbook.cn/a16b1ab0-6671-11ea-8540-bdc623044264)

上图所示的互联网银行系统，它使用外部的大型机银行系统存取客户账户、交易信息，通过外部电邮系统给客户发邮件。系统上下文图简捷、清晰，几乎无需解释，可以很好地将待建设的系统本身、系统的客户以及与系统有交互的周边系统展现出来。

#### **3.2 Container**

容器图，就是将上下文图（Context）中待建设的软件系统展开，显示组成该系统的容器（应用程序、数据存储、微服务等）。接续上面的例子，互联网银行系统的容器图示例如下所示：

![在这里插入图片描述](https://images.gitbook.cn/a8c41150-6675-11ea-970b-33f4f9e40da2)

容器图显示了互联网银行系统（虚线框中的部分）由四个容器组成：服务器端 Web 应用程序、移动应用程序、服务器端 API 应用程序和数据库。

容器图的受众可以是开发人员和运维人员，其主要用途有三个：

- 展现软件系统的整体形态
- 体现高层次的技术决策
- 展现系统中的职责分布和容器间的交互

#### **3.3 Component**

组件图，在容器图的基础上将单个容器展开，以显示其中的组件，这些组件可映射到代码库中的真实抽象。继续上面互联网银行的例子，我们将 API 应用程序展开，其组件图示例如下：

![在这里插入图片描述](https://images.gitbook.cn/dde977d0-667a-11ea-9416-9b7091176d0d)

组件图是细化到功能模块层面的设计图，是给开发人员看的，用于指导开发人员进行代码组织和构建。组件图的主要用途有：

- 描述系统由哪些组件和服务构成；
- 明确组件之间的关系和依赖；
- 为软件开发及交付提供框架；

#### **3.4 Code**

类图是对组件图中所示组件的进一步展开，是 C4 模型的最后一层，属于开发实施层面，可以显示组件的具体实现方式。在实践中，可根据实际需要确定是否画类图。继续上面互联网银行的例子，将银行系统功能接口组件展开，绘制如下所示的组件代码元素（接口和类）：

![在这里插入图片描述](https://images.gitbook.cn/f505d570-66b7-11ea-970b-33f4f9e40da2)

### 4.“G4”画图法

相较于传统的“4+1”画图法，在互联网领域，“C4 模型”画图法更为友好，“C4 模型”不仅可以清晰地传达系统架构信息，而且足够简洁、可维护。但是，上述两种画图法有一个共同的缺点——对非技术人员（如产品经理、运营）不太友好。那么，对于非技术人员，我们该如何绘制系统设计图呢？简而言之，少谈技术，多谈业务。

#### **4.1 业务框架图**

软件系统通常都服务于具体的业务，为了便于非技术人员理解，在画图的时候，我们可以从业务的视角切入，舍弃技术细节，绘制更加“上层”的系统设计图。以外贸业务为例，业务框架图如下所示：

![在这里插入图片描述](https://images.gitbook.cn/345329d0-605a-11ea-974c-2bc8ec103edb)

#### **4.2 业务主链路图**

理清业务的大致框架后，再从客户的角度切入，进一步梳理业务链路。在梳理的过程中，需要明确几个问题：客户的主要需求有哪些？痛点是什么？在业务链路中，我们可以为客户提供哪些服务？接续外贸业务的例子，梳理业务主链路如下图所示：

![在这里插入图片描述](https://images.gitbook.cn/9308acb0-6079-11ea-8710-d9de95ee7855)

#### **4.3 业务主链路节点展开图**

在完成业务主链路梳理之后，进一步对主链路中的重要节点进行展开，丰富细节。在此，仍然以外贸业务为例，就客户接入外贸服务平台的准入流程展开，如下图所示：

![在这里插入图片描述](https://images.gitbook.cn/f5a1e650-6080-11ea-8710-d9de95ee7855)

#### **4.4 业务技术融合图**

上面三个步骤均聚焦于业务，从整体到局部，自上而下，逐步细化，接下来，需要将业务和技术联系起来。需要特别注意的是，切忌涉及技术细节，而是从业务的角度出发分析——为了赋能业务，从技术的角度看需要提供哪些技术能力。在此，以较为复杂的旅行业务（如携程、飞猪、去哪儿）为例，业务技术融合图如下所示：

![在这里插入图片描述](https://images.gitbook.cn/a3ac3a50-608d-11ea-974c-2bc8ec103edb)

### **5. 画图工具**

**Visual Paradigm**

是一款功能强大、跨平台、使用便捷、直观的 UML 建模和 CASE 工具，它可以整合在其它 CASE 工具或者其他 IDE 工具中，[官网链接](https://www.visual-paradigm.com/cn/download/community.jsp)。

**Process On**

支持流程图、思维导图、原型图、UML、网络拓扑图、组织结构图等，不过可选图形不多，样式一般，[官网链接](https://www.processon.com/)。

**StartUML**

一款相对复杂的软件建模工具，旨在支持敏捷和简洁的建模，包含了大部分 UML 图，功能强大，样式、图形丰富，中文支持友好，[官网链接](http://startuml.sourceforge.net/en/)。

**PlantUML**

是一个开源项目，支持快速绘制时序图、用例图、类图、活动图、组件图、状态图、对象图、部署图等。同时还支持非 UML 图的甘特图、架构图等，[官网链接](https://plantuml.com/zh/)。

**Draw**

免费在线画图工具，尤其适合绘制流程图，[官网链接](https://www.draw.io/)。

**Omnigraffle**

主要用于绘制流程图、图表、组织结构图、UI 界面设计等。其最大的特色在于它有一些现成的模版，叫做 Stencil，这是一种可高度定制的图形模版形式，是该软件自身的独有格式，[官网链接](https://www.omnigroup.com/omnigraffle/)。

除了上面的工具，还有 Excel、PowerPoint、Keynote 等画图工具，读者可根据实际需要选用。

### 6. 总结

> 没有一种普适性的方法可以在任何场景下绝对奏效。——Ying SL

在画系统架构图之前，不要忘了初心——用它向受众传递你将如何构建一个软件系统或者现有的软件系统是如何工作的。换言之，没有最好的画图方法，只有最适合的画图方法，适合受众并能够将要传递的系统设计要素充分、清晰、直观地传递给受众的架构图就是好的架构图。

本文中介绍了三种画图方法，传统的“4+1”画图法显然已经不太适合现今的互联网领域，读者可作为参考，本文没有展开介绍；如果受众是技术人员，笔者推荐使用最新的“C4 模型”画图法；对于非技术人员，笔者推荐侧重业务的“G4”画图法。

**参考文献**

- https://www.infoq.com/articles/why-architectural-diagrams/
- https://www.infoq.cn/article/C4-architecture-model/